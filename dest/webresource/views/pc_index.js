define(["cPageView","cMemberService","MyCtripModel","MyCtripStore","myctripCommon","indexCommon","text!indexTpl_online"],function(e,t,r,i,a,n,s){var d=i.GetMessageListStore.getInstance(),o=e.extend({isAggregated:!0,viewType:"home",frompageurl:encodeURIComponent("http://"+window.location.host+"/webapp/myctrip/?for=test"),onCreate:function(){this.renderTpl()},renderTpl:function(){1===a.checkLogin()?(this.$el.html(s),cPublic.ctripMenu({show:!0,buName:"home"})):this.loginAction(),this.elsBox={msgCentre:this.$el.find("#message_centre"),tabCan:this.$el.find("#ordertab"),orderCan:this.$el.find("#orderlist"),favoriteCan:this.$el.find("#favoritelist"),progressBar:this.$el.find("#progress"),currentLvl:this.$el.find("#startlvl"),nextLvl:this.$el.find("#endlvl"),orderMore:this.$el.find("#viewMore"),userName:this.$el.find("#username"),memberbox:this.$el.find("#memberbox"),userLevel:this.$el.find("#user_lvl")}},onShow:function(){var e=this;if(1===a.checkLogin()){if(this.handleBaseUserInfo(),this.renderUserInfo(),this.wallet(),null===d.get())n.requestMessageInfo(function(t){e.renderMessageInfo(t)});else{var t=d.get();e.renderMessageInfo(t)}n.orderCount(function(t){for(var r in t)e.elsBox.tabCan.find("#"+r).text(t[r])}),this.requestOrder(),this.favoriteOrder()}else e.loginAction()},events:{"click #viewMore":"moreJump","click #favoritelist li":"favoriteJump","click #i-mail":"mailAction","click [data-href]":"nextPage","click #ordertab li":"tabClick"},renderUserInfo:function(){var e=n.handleBaseUserInfo(),t="";"diamond"===e.grade?(t+="<dl>",t+="<dt>免费为乘机人订制航班信息</dt>",t+="<dd>网上预订机票，您可在乘机人信息界面填写相关手机号，订单确认后，携程将为乘机人免费发送航班信息。</dd>",t+="<dt>贵宾俱乐部活动</dt>",t+="<dd>携程贵宾俱乐部每月举办各类精彩活动，如精英论坛、聚会沙龙、演出展览等，诚邀尊贵的您参与！</dd>",t+="<dt>钻石兑换专享</dt>",t+="<dd>当达到钻石级别，可享积分商城钻石专区低积分奖品兑换特权。</dd>",t+="</dl>"):"platinum"===e.grade?(t+="<dl>",t+="<dt>专享优惠旅游度假产品</dt>",t+="<dd>携程旅游度假专家，将为尊贵的您提供专属您的旅游线路，折扣实惠，线路优选！</dd>",t+="<dt>贵宾俱乐部活动</dt>",t+="<dd>携程贵宾俱乐部每月举办各类精彩活动，如精英论坛、聚会沙龙、演出展览等，诚邀尊贵的您参与！</dd>",t+="<dt>美好旅游纪念品</dt>",t+="<dd>自2012年5月31日起，凡您在携程成交任一旅游线路（部分不可享受），将赠您丰富的旅游纪念品。</dd>",t+="</dl>"):"gold"===e.grade?(t+="<dl>",t+="<dt>关怀短信</dt>",t+="<dd>预定出行时，免费提供目的地城市的天气状况短信。</dd>",t+="<dt>参加精彩纷呈的积分活动，享有抽奖机会</dt>",t+="<dd>可以参加丰富多彩的积分活动，可赢取旅游产品抵用券、携程刊物、海外旅游度假等机会。</dd>",t+="<dt>订酒店臻享哈根达斯</dt>",t+="<dd>每预订一张酒店订单，即可使用积分兑换“哈根达斯买一送一”礼券一张</dd>",t+="</dl>"):(t+="<dl>",t+="<dt>订海外旅游度假，享24小时中文热线</dt>",t+="<dd>已开通夏威夷、普吉岛中文热线，为会员提供咨询和紧急帮助服务。</dd>",t+="<dt>积分累计加快</dt>",t+="<dd>预订成交享有积分奖励，无线预订，积分累加更多！参与有奖调查、抽奖等都也可获得积分！</dd>",t+="<dt>积分兑换丰富礼品</dt>",t+="<dd>参与积分活动，有机会获得旅游产品抵用券、携程刊物、海外度假游等奖品。</dd>",t+="</dl>"),this.elsBox.userLevel.append(t)},renderMessageInfo:function(e){var t=e.MessageList.length;if(e&&t>0){var r="";this.elsBox.msgCentre.find(".home-mail").append('<span class="unread2"></span>'),r+='<div class="message-alert"><ul>';for(var i=0,a=t>3?3:t;a>i;i++){var n=e.MessageList[i].ContentList.RedirectUrl||"http://my.ctrip.com/home/Message/MessageList.aspx";r+='<li><a target="_blank" href="'+n+'">'+e.MessageList[i].Title+"</a></li>"}r+="</ul></div>",this.elsBox.msgCentre.append(r)}},handleBaseUserInfo:function(){var e=n.handleBaseUserInfo();e&&(e.grade&&this.elsBox.memberbox.find("#"+e.grade).show(),e.userName&&this.elsBox.userName.html(e.userName),e.degree&&(this.elsBox.currentLvl.text(e.degree[0]),this.elsBox.nextLvl.text(e.degree[1])))},tabClick:function(e){var t=this.elsBox.tabCan.find(".current")&&this.elsBox.tabCan.find(".current").data("key"),r=$(e.currentTarget).data("key");t&&r&&t!=r&&(this.$el.find("#ordertab li").removeClass(),$(e.currentTarget).addClass("current"),this.requestOrder())},loginAction:function(){t.memberLogin({param:this.frompageurl})},nextPage:function(e){var t=$(e.currentTarget).data("href");Lizard.jump(t)},moreJump:function(){var e={NotTravel:"unuseorderlist",AwaitPay:"unpaidorderlist",AwaitReview:"uncommentorderlist",All:"allorders"},t=this.elsBox.tabCan.find(".current").data("key");Lizard.jump(Lizard.appBaseUrl+"orders/"+e[t]+"?for=test")},favoriteJump:function(e){if(!a.isOnline){var e=$(e.currentTarget),t=e.data("statusid")||"";if(0==t)this.showToast("此产品已下架");else{var r=e.data("url");r=r.indexOf("?")>-1?r+"&":r+"?",Lizard.jump(r)}}},mailAction:function(){var e=d.get(),t=(e?e.count:0,"/webapp/message/messagecenter");Lizard.jump(t,4)},wallet:function(){var e=this;n.requestBalanceInfo(function(t){if(t&&t.balanceInfo&&t.avatarUrl&&t.lvlProgress){for(var r in t.balanceInfo){var i=t.balanceInfo[r];e.$el.find("#_"+r.toLowerCase()).text(i)}e.elsBox.progressBar.css("width",t.lvlProgress);var a=e.$el.find(".member-pic").find("img")[0],n=220,s=n*parseFloat(t.lvlProgress)/100||0;$("#_basicpoint").css("left",s+"px"),a&&(a.onerror=function(){this.src="http://pic.c-ctrip.com/h5/rwd_myctrip/portrain_unlogin.png"},a.src=t.avatarUrl)}})},requestOrder:function(){var e=this;n.showLocalLoading("#orderlist");var t=e.elsBox.tabCan,r=e.elsBox.orderCan,i=e.elsBox.tabCan.find(".current").data("key")||"All",a={PageSize:3,PageIndex:1,OrderStatusClassify:i};n.filterOrderData(e,a,function(a){if(a&&0===a.resultCode)if("undefined"!=typeof a.orderCount&&a.orderCount>0){var s=a.htmlStr&&a.htmlStr||"",d=a.orderCount>3?"block":"none";s+='<li class="load-more" id="viewMore" style="display:'+d+';"><a href="javascript:;">更多订单&nbsp;&gt;</a></li>',t.find("#"+i).text(a.orderCount),r.css("height","auto").html(s)}else{var o='<div class="home-none" style="height: 240px;"><i class="none-product-order"></i>暂时没有相关订单</div>';r.css("height","auto").html(o)}else n.showErrorTpl("#orderlist",function(){e.requestOrder()})})},favoriteOrder:function(){var e=this,t=e.elsBox.favoriteCan;n.showLocalLoading("#favoritelist");var r={QueryList:[{BizType:"HOTEL",ProductType:""}],SortBy:"CreateTime",SortType:0,StartOffset:1,ReturnCount:6};n.filterfavoriteData(r,function(r){if(r&&0===r.resultCode){var i=r.htmlStr&&r.htmlStr||"",s='<div class="home-none" style="height: 240px;"><i class="none-product-favorite"></i>暂时没有相关产品</div>';if(i&&t.css("height","auto").html(i),!i&&t.css("height","auto").html(s),a.isOnline){var d=t.children("li"),o=d.length>0?!1:!0;o||d.each(function(){var t=$(this),r=t.data("url"),i=t.data("statusid");t.wrapInner("<a>"),t.find("a").attr({href:r,"data-statusid":i,target:"_blank"}),t.find("a").on("click",function(){return 0==i?(e.showToast("此产品已下架"),!1):void 0})})}}else n.showErrorTpl("#favoritelist",function(){e.favoriteOrder()})})}});return o});